const express = require('express');
const fs = require('fs');
const path = require('path');
const axios = require('axios');
const archiver = require('archiver');
const pLimit = require('p-limit');

const app = express();
const PORT = process.env.PORT || 3000;

const groupIds = [5947482,4702275,540686,524288,4915265,884742,4603991,6602867,6144067,589866,4604003,4636785,4604025,688202,4636677,622668,8273973,4636683,49230,4685843,4702239,4669465,4603943,966760,4636705,65648,655478,475294,4669659,622740,589992,524458,4604133,4604153,4898955,4718731,4604037,4653200,4636817,4636829,5898424,8765549,7930001,4604079,475374,4882593,4767909,704764,6357149,4636857,6472047,7160160,4669791,9699763,4653430,82242,4636933,4686081,6471981,7471395,4604179,4604191,82278,557410,6226227,4669739,8159505,4636979,4604221,4669755,7930361,4637143,4800987,8028649,5161434,524692,4637145,6472137,7717337,4604395,590268,9109821,4899325,4604295,4718983,6013316,66028,4604329,4637107,4604351,82426,7848567,4719177,705036,4637249,4751937,475662,5538398,557570,4637257,4670039,475664,4670047,6374013,4604507,4670041,4833903,6373959,8274521,4702831,4637299,901690,4686343,6373921,7422517,4604419,6373931,4637197,66128,98898,4604437,885336,7717423,4686369,4637217,606840,4604469,508530,4833855,6373915,4604475,9224945,66176,4702913,5538496,983706,4604639,672404,4637411,9617981,4637427,721588,459478,4670101,4719261,4637341,4899477,4637345,49900,6832773,688868,4604597,688882,4637369,4637505,8356727,4604751,4703051,492296,788,7848803,4686673,770844,606992,4703079,4604773,4817773,721702,8160083,4719483,4735859,49980,4702979,4768527,6898489,4637469,82802,4719567,590734,6456307,82838,8029155,787346,705428,869292,4637669,7160776,944,4637687,4604915,4637691,4637689,459704,4670343,7799739,787392,66518,4604817,934868,6062979,4653984,902122,4670381,508906,4604851,508922,508920,4637625,4637765,4719711,6898765,640044,902178,640060,9569449,4670471,4604935,787524,6521907,558162,4637725,4604955,4703257,66658,4670525,4637753,5997790,7046371,4605131,4637899,4637905,6898891,4605167,967844,4637933,918690,4719865,5195006,574650,4670709,722108,4637951,722100,492740,4637835,4637833,4605079,541914,4637845,4605075,4637843,4637853,541922,4670637,591074,672996,4637873,4687033,4637881,4638019,4769105,4703591,4638055,4752749,509216,4638057,6473043,656690,6243685,4654342,4605195,968028,6456629,4637981,4736279,4687143,4703527,4605223,4670755,4637985,4719905,460140,902524,476528,4605247,4605377,66952,771482,4638177,4638187,525752,869844,4638109,4605349,4605353,4916665,869886,67060,4638137,656904,968204,738824,4638285,50700,476692,67090,4638289,6047303,656918,4818519,4884053,5867122,83500,656956,607792,4671097,5522960,4605453,4638221,4638225,935510,951890,886352,607850,673390,4671009,4638251,771686,5703200,4605503,476812,4605649,4638429,9963012,4605659,542358,8619571,509622,4605681,4638449,4622079,4622077,8275651,4622075,6456999,4638337,8373937,4834961,4638377,4622007,4916925,4605627,4638529,4687693,4622153,542480,50968,5867328,4638557,4835157,67356,9013163,722734,4622179,6358857,591654,5195644,640816,5212018,4818807,7833395,4605697,4605709,460618,4622091,4802329,4638487,4605719,4769561,4687635,9406421,4671261,4638491,4949782,4753195,4638499,6506251,9881598,4622123,526200,903038,51062,657270,739188,4671431,4638671,739200,5818326,4622293,4622291,591760,83868,4605913,4622311,4638689,755618,4638701,4605933,4736997,4638699,4622321,4605951,51130,83902,4638713,4638595,739282,5621646,4638621,4605851,4622235,67548,7161778,903122,4622241,4638655,4638653,4638651,4851639,739318,870384,4606023,4606021,4622421,4606033,575506,4638821,4606053,4638831,7604293,4638839,641082,968758,5998690,4737139,4638843,6948949,4638727,460878,5277722,6260753,4605961,919640,4622367,6441017,4720663,4622381,968830,4737083,4638773,739454,4671551,919670,67718,4622543,4638921,4606163,4606161,4851933,4606175,6015169,4622557,5343434,4638963,4638961,4622589,4606203,4622587,4884727,4638851,4606081,477388,4851841,542916,9947224,4688021,4622485,4720787,657646,4638883,4622505,477426,7604365,4622661,5146952,559360,624924,674076,674070,4639067,7883101,4639075,4622701,6146417,4622697,706874,4901247,756028,5998956,772402,51520,461126,4606215,4638981,4688131,4638979,9013697,4671759,6375723,4638985,4622601,51540,641374,903514,4639003,477538,5196074,4606255,4933927,5491006,477558,4606259,4622643,4770111,4884937,4639169,7227877,4884955,4639189,4753885,4671953,887190,4622813,4770263,4622821,641440,4606445,543142,674232,4606453,6867421,4704761,526792,4639109,4622725,543180,4639107,7227839,7227837,707036,7227829,4606363,952808,936444,9013621,4884919,4639163,4672069,4639301,51716,4639299,5884508,887302,51726,84498,7834223,739882,4639329,4639339,4655735,4655729,4655739,4672005,8555201,4622851,4606477,4622859,4622857,6228489,9210581,4622887,7162376,4622899,772732,4753975,9013769,4868815,658060,4606657,5982928,7228129,4655831,4639447,527004,4623057,4672223,4655837,7228145,68256,7228105,4639471,6228723,8882741,4868861,68282,4705019,4655747,4639363,4655745,4803203,4655757,68300,4672151,4655767,4655761,4901533,920278,6572729,4606631,4655781,51940,7260809,4623021,4606647,576254,4655807,4672185,4655801,4655941,6343523,4655937,4655949,4639565,7228261,4672331,4639569,5163862,4639583,690960,4623197,674582,4705127,4606821,52006,4655983,4606831,7228231,4606839,4639603,4655985,527166,4770575,4737797,969560,4655903,4639531,8375057,4655913,4770599,592762,4639539,4655935,4655931,68476,6015961,4656067,527232,4656091,68512,4639727,4656107,9767716,527290,674744,4770811,4639733,4606963,4606961,9145137,789430,4639741,4656123,658378,4623237,4656015,4656011,4606859,936896,4623263,5819266,4836245,4606885,4639649,4656043,4918181,4656041,576504,6376339,4639665,52222,4656199,5082190,9096333,953348,4623437,4656203,789532,4852829,4869203,4656221,4656219,8604839,4656225,4656239,4738145,4656237,4721763,4689003,4656245,4639859,674876,4607089,4607103,4607101,8883385,4623481,494662,4606983,592970,4623361,4656159,4836369,740434,4656155,658538,7654423,4639781,4639779,6229049,4623393,4656173,4623405,4656171,4656181,4656177,609406,4639793,6114527,4623557,724108,4607179,4656329,4590793,756868,4656343,4656341,4656339,4639953,4656351,4639967,4656361,4590835,4656383,4623611,4656263,4639885,4656279,4656277,8277165,9079891,4705437,4721833,740590,4656289,658668,4656303,4656301,969954,675066,4672689,4639935,4639931,4656455,4656451,4656449,4623681,4640079,4623693,4656459,4935007,544016,593168,4656477,4656475,4656473,4640089,4656481,740642,4656491,4902267,511284,4607349,8441269,4607345,4640113,68924,4656505,4607237,6851887,4640015,4820227,4640013,4623627,5360926,4656401,68950,626014,4640029,4656411,4836631,4640037,6851843,4658937,4642433,6756015,5363352,743108,972510,4642453,6756019,546512,4609691,4642471,4593315,6542981,6755969,4626081,4609711,4642477,7657094,644858,6755987,4626247,4659013,4593475,4839257,464662,4593493,9066387,4626279,4691811,6543177,4593515,4609909,8312653,6543191,5942,6887263,612158,8197957,4626303,4593535,4593533,4609917,4626299,4593409,6756141,4658953,4658963,6543157,6543165,6543107,4626213,6543109,4790049,4626217,6756119,6543123,4609847,4675389,4593605,8001529,4855759,5265368,4626383,628610,6032,7788525,4806613,4659163,481178,4659161,6756291,4708335,8312791,4593645,6821851,4642805,4593653,6068,776126,4593649,88002,6756259,6969263,4609935,8771401,4642709,6756275,645086,4691871,6104,6756287,4675483,88030,4593573,4609957,4609953,6543255,4642751,55292,4659271,759820,8165489,5937226,4708447,4659293,4593757,4659291,6182979,6854773,4659301,6756419,4659317,4642933,6756447,4692095,6363169,4659207,6756387,4610051,4659221,7575585,6226,7460909,6756359,4626469,6002744,9443581,6756379,4741175,6756583,55426,6445287,8313081,6281431,4823235,4593869,710790,776324,465044,4626645,4610259,923798,776336,727184,71836,6756601,4610265,7788761,4626679,6756565,4593909,6756561,4626565,6051993,71880,5085318,6756523,4970630,4593813,6756541,481500,661716,4610215,4839595,4610211,4642991,6756493,4626603,4610219,4610227,88312,6756507,4593849,6402,4593987,612622,4610381,6019415,7231843,5888320,4610397,4643165,4594009,956712,4594027,6756693,4594035,55610,4921713,8313155,8165697,55614,4643193,4610425,6756643,6756641,8165687,4626701,645442,6756651,4593929,4610313,4593943,6756661,4593941,4593949,6445375,481626,5019922,4643097,5888262,5101868,530794,4626725,481634,4692271,4626731,678244,4659497,645478,7395615,579960,4593975,6756629,973180,4610357,4905279,760178,530806,8116485,6445341,6756835,579968,7100903,7199201,7526911,4626891,4626903,8116713,579998,4626911,4659677,4594137,760234,4774381,55718,6756811,4725223,4659697,4610557,4594171,7100845,4692357,4659589,530892,4659599,6379949,88524,776666,4675985,8313257,530898,4594077,4692379,4659621,7068045,6642061,547298,4610475,4594089,8165775,4626869,645628,6756761,4741559,6543971,4676167,6756965,4659781,629258,9788054,530956,776718,498188,530968,6756981,481822,7510633,4659801,5462642,4856429,530980,4659817,6183537,4659827,7674433,6363734,4676219,4627067,72252,9542353,580170,7395891,4659715,4610561,6642221,645696,629314,645700,4659721,547398,6756905,7510589,531034,957020,4594213,8165913,4774435,4659753,629350,4659765,481918,7510537,8165889,4594233,4676301,4659917,4676309,4807389,4610771,6757061,4627169,4594401,4594415,6757067,514742,4659957,531132,6757075,4659955,4856573,4905713,4758259,4774647,694984,7150248,4594307,4889223,4594313,4594327,4627089,957140,4659869,4610717,4659867,6756997,4659873,6888,6363784,4610733,4610729,4659895,4692657,4610737,4709055,7314067,6757017,498438,498434,4692815,7035749,6757233,72470,9182099,7789407,776998,4594539,6167403,4610937,56130,6757155,744270,4594447,4659981,4676365,4594443,645958,4594451,4594461,4627227,662356,613206,4676391,4610855,629612,760686,4660015,6757135,465774,4610857,662392,4774715,695164,4594627,5856222,6757357,4611017,6183885,6298611,5249990,4627409,4692967,4594663,564142,4611055,4611049,4594665,4660215,4594677,6757331,4611071,6757285,4660097,662466,8313783,4594581,7126,6757305,4594595,4610999,4660147,6757267,72692,6757265,7170,629772,4611137,4594763,6757481,6757493,4693073,8641691,8494235,6184005,4627555,6757441,6757453,6757459,4627571,8133689,6757409,4627457,8313913,4660237,4594701,6757431,6757429,6003726,629852,4611103,7576623,4611099,4660249,4611097,4611111,4774953,4774955,711782,4627511,4725819,4594739,4611121,6757405,515196,5823524,4676665,6708465,957590,6757627,760982,6757571,564396,4676833,4709615,4627693,6757589,4660469,4594929,4693245,4594941,8412219,6036711,466118,6364341,4791453,6757553,4660383,4611229,515292,4627611,8314003,4611255,4791483,7101599,8313997,4775103,4627645,4676793,4660551,4660545,515340,548100,4611403,4840795,4595029,7527777,4595025,7450,777494,4611417,4709733,597294,531770,4660597,7740739,4595057,4627837,5561704,580938,6757669,482628,6757667,4594947,6757677,4660489,4594963,6757681,4594973,4611357,580950,515416,6757639,8314143,56674,6757633,6757645,4594987,7527711,56686,6757641,6757651,4627763,56696,4807989,679286,4676921,4611385,4627911,4595141,4677077,597394,6757883,925074,4595183,4627945,6266343,564658,957872,4676995,4627841,6167961,5021058,4611479,8199599,4627861,712158,4677011,7640,4660637,4627867,4611495,5725622,7708051,8314259,941566,548350,4677055,4611515,4660807,4595267,663052,5201478,531974,4628041,7790201,7698,7790181,7700,6086213,4628071,6757957,4628067,56876,8314447,7742,4595321,646728,745036,6446633,679516,56918,89688,761428,4677159,4791853,5152294,4628013,4906535,4873765,4660789,4677171,89716,9854688,695922,4628031,4742707,4595261,630400,712320,7790307,8314601,7724783,7790301,4628211,4595441,4824823,4595449,6758051,7876,4693645,564930,4693643,532184,7888,614110,630482,8642143,712422,5004986,581384,6102877,991006,4661077,4906845,4595551,6217537,4595559,4628321,4726631,4628337,8970163,4595577,4628227,8006,4595457,4628235,4628247,4595479,515922,679762,4628255,4628253,89946,6315839,630632,8167199,8040,4661037,515946,4661047,7790341,4661043,4628275,6037289,630652,778110,8380169,8314627,8314625,4595655,696200,5283794,5201868,4661195,4661201,57238,4644830,614294,4644838,8314841,4693999,4628457,4661239,696248,4792317,4595699,4743155,4595589,778182,6758325,4661139,5496710,778206,630738,8822618,663508,8658779,4595609,647144,712684,4677547,597990,4710335,6758303,581618,4661177,4595791,4661335,7708769,4628563,4628571,6447229,532522,8642721,4661347,4661359,8314959,4628597,516156,499788,8268,680024,4661267,4988946,8642781,8314911,4628515,4825135,6283311,90224,696440,6758421,6905879,4923595,57472,4661443,761998,4628687,4677837,4727001,630936,467092,8315109,614548,4890837,4628697,8921111,4595951,8364,9396285,4727035,516286,57534,4595845,565454,4595855,6758573,6414509,4595851,499912,4595849,6758585,4677785,8416,4628647,4595879,4726957,4661417,4726951,6201521,4628661,4595889,6758555,5251246,565512,467200,4923713,631042,4628819,4989268,4596063,6267201,745748,6758725,4923751,5529952,8642999,4661631,8315205,4628861,926026,4595971,4858137,9724361,8542,74082,4677923,8554,8643053,4628777,57716,4677945,8642821,6578659,532864,8586]
const gifDir = path.join(__dirname, 'gifs');
if (!fs.existsSync(gifDir)) fs.mkdirSync(gifDir);

// Custom headers (can rotate if needed)
const HEADERS = {
    'accept': 'image/avif,image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8',
    'accept-language': 'en-US,en;q=0.9',
    'dnt': '1',
    'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',
    'cache-control': 'no-cache',
};

// Download single .gif by groupId
async function downloadGif(groupId, attempt = 1) {
    const url = `https://img.naukimg.com/logo_images/groups/v1/${groupId}.gif`;
    const filepath = path.join(gifDir, `${groupId}.gif`);

    if (fs.existsSync(filepath)) {
        console.log(`✅ Already exists: ${groupId}.gif`);
        return { groupId, success: true, skipped: true };
    }

    try {
        const response = await axios.get(url, {
            responseType: 'stream',
            headers: HEADERS,
            timeout: 10000
        });

        const writer = fs.createWriteStream(filepath);
        response.data.pipe(writer);

        await new Promise((resolve, reject) => {
            writer.on('finish', resolve);
            writer.on('error', reject);
        });

        console.log(`✅ Downloaded: ${groupId}.gif`);
        return { groupId, success: true };
    } catch (err) {
        if (attempt < 3) {
            console.warn(`🔁 Retry ${attempt} for ${groupId}`);
            return downloadGif(groupId, attempt + 1);
        }
        console.error(`❌ Failed: ${groupId} (${err.message})`);
        return { groupId, success: false, error: err.message };
    }
}

function chunkArray(arr, size) {
    const result = [];
    for (let i = 0; i < arr.length; i += size) {
        result.push(arr.slice(i, i + size));
    }
    return result;
}

// Endpoint to start GIF scraping
app.get('/scrape-gifs', async (req, res) => {
    const limit = pLimit(5); // limit concurrent downloads
    const majorGroups = chunkArray(groupIds, 500);

    for (let i = 0; i < majorGroups.length; i++) {
        const group = majorGroups[i];
        console.log(`\n➡️ Processing batch ${i + 1}/${majorGroups.length}`);

        const promises = group.map(id => limit(() => downloadGif(id)));
        const results = await Promise.all(promises);

        const successCount = results.filter(r => r.success).length;
        const failCount = results.length - successCount;
        console.log(`📊 Batch ${i + 1}: ✅ ${successCount}, ❌ ${failCount}`);
    }

    res.send(`🎉 All GIF scraping done! <a href="/">⬅️ Go Home</a>`);
});

// Endpoint to download all gifs as ZIP
app.get('/download-gifs', (req, res) => {
    const archive = archiver('zip', { zlib: { level: 9 } });
    res.setHeader('Content-Disposition', 'attachment; filename="naukri-gifs.zip"');
    res.setHeader('Content-Type', 'application/zip');
    archive.pipe(res);
    archive.directory(gifDir, false);
    archive.finalize();
});

// Home
app.get('/', (req, res) => {
    res.send(`
    <h2>🖼️ Naukri GIF Scraper</h2>
    <p><a href="/scrape-gifs">▶️ Scrape GIF Logos</a></p>
    <p><a href="/download-gifs">📥 Download All GIFs (ZIP)</a></p>
  `);
});

app.listen(PORT, () => {
    console.log(`🚀 GIF Server running at http://localhost:${PORT}`);
});
