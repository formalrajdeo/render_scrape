const express = require('express');
const fs = require('fs');
const path = require('path');
const axios = require('axios');
const archiver = require('archiver');
const puppeteer = require('puppeteer');
const pLimit = require('p-limit');

const app = express();
const PORT = process.env.PORT || 3000;

const scrapedDir = path.join(__dirname, 'scraped');
if (!fs.existsSync(scrapedDir)) fs.mkdirSync(scrapedDir);

const groupIds = [180825001448,180825001399,110825014213,210825019762,060925008420,290825020677,280825010159,220825013710,270225924437,100925503516,081223500407,100925502326,081223500411,010825506421,070525500262,100925503515,270624500677,100925502459,120825012329,280825011303,280825018156,040123500710,040123500712,040123500711,040123500707,060818501109,040123500713,140123500519,040123500708,040123500709,040123500716,040123500714,040123500715,110725924023,100118500616,240525500333,240325500404,130825027979,120825010076,130825028084,120825035106,210325501730,290525503912,040425500067,090425500051,260525500087,220525500061,280525501100,210525500062,090925029333,020825005225,050824502475,121224506166,240725501759,010925017543,100925033280,020925024197,210825016445,090925028009,080925026573,020925023901,080925008567,260825022454,020925021231,020925023432,100925033581,100925033131,020925021854,020925023385,140425013896,020925023487,020925020106,070725014666,010925005023,190825500953,131224504568,190825500954,140825033916,180825502060,140825032668,180825502058,140825033354,190825500316,210825028323,180825502062,180825502066,180825502064,260624502228,260624502226,050925020664,050925018017,120825017430,050925018062,050925019860,040216503902,310815503739,200216500085,040216503907,170815500514,170815500490,080419500567,080419500566,040216503905,310815503691,301118503545,040216503904,031218501528,020925024659,240223501091,290822501937,110322500277,091123500243,030322500157,111223501419,120822500199,030322500158,110422500104,111223500896,111223500154,030322500480,170725501827,240525500215,210325501228,290425505940,190825502057,110325503303,170725501828,040925500535,280625502402,050925504427,280325502792,010925015943,310725020554,290825018095,270825020758,050925504885,300525502077,070725007546,120825028431,220825027923,210825039801,190825012435,110825011008,100125011499,070825020888,280825019328,280825019549,090925031990,030925030189,030925028500,090925033021,100223500006,100223500005,100925038966,100925035684,050925012348,100925036849,100925033334,140525502495,110325502771,240725015291,230825017319,011217500651,190916501290,301118500726,011018500059,011217500782,011217500712,011217500676,191015500032,011217500751,010615505060,301118500706,010615505043,010615505052,220816501382,011217500767,011217500673,191015500030,011217500628,011217500763,011217500809,170425010234,300825012351,300825011850,110825012407,110825010745,120825018009,110825014190,250325502137,220825030101,050725500133,241224503544,230425503048,070225501051,020525005098,280825017868,250425012978,250425006220,160725024126,240625505555,240625505553,240625504802,240625504693,240625504692,240625505103,310725501058,310725500396,040825500538,310725501043,040825501037,160525502101,170725501486,160525501698,160525502102,240725503179,160525501482,040225920800,040225920298,230425017507,090925033190,070925001732,250825007813,040925026231,090925033286,310825004443,090925029147,310825004460,280825016597,290825008623,180725016183,040925006376,010725502227,010725502486,010725502249,010725502923,010725502550,010725502770,010725502878,010725502763,010725502460,110725508625,050925020845,040825505389,270625501859,100725505048,010825506047,270625501860,100725504684,270625501858,040825504071,040825505390,110725508613,190725500419,040825505391,060225507848,190725500700,020925023549,190725500415,260625502361,170725503845,280325502737,160725502454,270825502541,280325502738,270825501350,120725501086,210825019562,180725503372,200225503980,090925012938,210225502289,230125502074,270825502540,020925501441,240325500521,090925033154,030925501512,200825502846,160725502192,190325508500,140825024094,080925033459,250320500317,170815501503,040216502636,250815500901,020915500712,040915503161,250815500856,280915500613,050216501986,040216502723,310815501457,090116500331,040216502861,130116500156,250815500882,250320500316,040216502863,310815501458,010925010335,290125920927,270825005828,090925032437,250825022023,250825007242,280425500085,280425500086,291118600250,160223502308,260425503075,071124502558,160223502302,290425502431,200617502057,070318500903,231220500448,231220500442,240119500822,190725501411,010519500805,070318500902,180319501681,250723500451,070318500904,200715501586,290116501592,050417501700,071015500161,290116501746,290116501667,050417502523,290116501875,290116501644,290116501573,200116500415,270825012348,190825028339,290825028296,130825501720,130825501695,130825501726,130825501736,130825501194,130825501686,130825501445,260825010376,140825013329,010925008934,290725014260,240625031502,200825027458,130825009188,150825000045,310825001352,100925010038,110825018964,250825023137,180825003061,260825019833,230725021044,200825030730,250825024213,070825018880,270825020744,210525032563,110825016230,140825015229,160825003762,140825014429,140825015909,190525018334,210525031097,180825021859,110925013610,180825003253,290725012566,120825014554,210825043963,280425002519,130825021290,090925012620,280825013575,220825029013,110825013962,260825011201,090925012942,130825006975,170125503066,160825003040,160825002189,210725500736,210725500715,210725500737,210725500716,210725500738,240522500191,021222500026,021222500027,090725020608,180825020036,110825009081,170725038219,190825025005,150625004034,100725020966,220825009695,030425022718,190825025957,250825505086,280725500435,120825500656,030925500952,120825502504,160525503423,040725028224,120825015847,120725502904,030925502407,290825023251,160425505470,160425505461,190525501847,220725501853,010925007259,090925503112,160425505471,290825018500,090925502564,160425505458,160425505467,250825004085,160425503053,040925501348,130825502303,090925501943,300924501715,070923500286,090925020176,060923501117,060923501114,060923501119,060923501115,070923500285,080424005699,060923501112,250325008566,300924501716,060923501116,060923501118,060923501113,060923501121,300924501714,060923501120,300924501713,060923501122,290825019055,190825027071,140825030056,140825037504,260825502467,260825503558,260825502095,090925500358,050825502928,221223501074,130825501541,120825500685,250625504016,260422501251,200825029584,131224500581,250825500800,200325509152,140825502251,200325509151,210825502725,200325509150,020925503231,190825501012,040825505628,121224501545,240724502376,220825500344,220825500345,220825500640,220825500641,010324500472,120324500394,120825913724,070224500632,010224501175,120825931333,030425020186,050925011567,190225011252,240724501220,020925500686,020925500233,140625501443,191124505706,020925500057,140625501442,020925502568,140625501440,020925500692,020925500694,020925500687,110724501723,040625501852,201224503094,080925502779,080925502778,130625501406,100625502707,020925500697,300425504315,280825007472,020925010793,250825002720,140525017899,210825019880,130725003705,200825020013,250825021831,200825504017,160125502182,100925501180,170625503768,060225502748,140125501280,100925500739,120725502240,170625503994,230725503199,260625500069,100625502215,250825504780,100925500267,170625503993,170225501199,100625502241,070125507190,090925502698,160725502151,080925020976,110825013491,190825029327,190825028603,190825025000,190825029016,190825029856,180825019990,120825013172,180825003005,250119600362,200825021948,250825016132,080925006774,240325502144,030725502073,261224501197,261224501386,261224501384,261224501385,261224501387,261224501383,090525502452,210825014402,280825014728,220725026105,160725501325,010525002942,040925011579,120525503873,140725006082,200325004963,190525503437,190525503433,040425007188,190525502536,070425000969,120825920601,040925010089,010925013293,080925022454,100925024307,190825020073,091117501339,061216501347,140916500389,070516500030,091117501338,060816500201,071116500335,091117501337,071116500345,140916500518,060816500409,230522500917,230522500918,170625504001,090925502710,200525502142,040225502625,180625503839,061124501119,080825503009,130225501985,290725503245,250825503933,050325502275,301224503820,071124500484,070525010314,300525501565,061124500972,061124501121,140625501549,110325502157,100925502494,121124503836,060225506846,121124503813,060225506845,130624500328,060225506843,111124501895,130624500323,130624500322,111124501893,060225506844,130624500321,130624500326,111124501896,111124501897,111124502188,121224504036,111124502189,050925026477,280825010980,130825013090,090925014063,180825005536,010925012998,160725016165,210825013732,010725023353,210825021098,270825008331,100925021350,270825006003,220825021672,250825018130,010925004010,090925027174,040925003541,220825016447,101123500901,101123500902,101123500899,101123500898,101123500900,050625503193,090925503437,180725502946,220725504974,170325503497,220725504975,220725504976,040825507695,110724500429,100725502275,200325507237,110724500428,080425504198,120225502714,080925500859,290425500708,050725500429,121223500860,290825502188,100524501938,090925028136,050925019863,030123501279,180825003578,090925028778,070725012682,050925021783,050925024020,020925015318,140825033891,010925013140,020925015108,030123501590,030123501280,030123501277,250825019478,230824501581,230824501583,230824501586,230824501592,230824501593,230824501600,230824501582,230824501596,230824501607,290824500938,230824501588,230824501605,230824501580,230824501604,230824501610,230824501595,230824501587,230824501601,230824501608,230824501585,200717500787,130715500924,130715500984,130715500965,260815503913,130715500989,160517501152,050216501468,020216502748,240715500633,020216502613,301118503445,160715501804,291215500201,130715500949,260815503910,020216502743,020216503033,120815500856,301118503448,250825505202,210425502943,180325506651,280525502996,200325503910,040225505812,250825505029,050925503646,170425502416,050525502493,300725501748,171024500957,060825502695,240525501164,040225505833,220725503729,030925503213,300725501750,220525502295,070525503024,120121501868,030723500286,120121501872,030723500287,030723500288,120121501874,120121501869,120121501871,120121501870,120121501873,080425504225,300425501087,110825502797,010825501133,200824500811,180825018393,200824500810,040925502963,060319502103,111023501491,140825037554,250825007743,250825008542,141122500031,250825007789,280825502934,280825502978,290825502445,280425504079,280425503017,180325504533,180325502166,290725503618,190625501776,290825502520,220525504541,190525505956,310725501192,300725505486,270625504799,270625504986,310725501520,310725501102,290825502130,260825504475,050925504175,050925500424,050925500421,080925501962,050925504156,100925503512,050925500425,050925500422,050925500839,050925500418,050925504180,050925500419,050925504141,050925504086,050925504172,050925500426,050925500430,050925500427,050925500415,080925502142,140225021969,170625504224,080525501460,140625500695,121224503812,120525501159,100425501152,210823500275,171224502927,050925009514,100925040407,050925009037,291118600299,280825501160,270825501517,270825005600,280825501723,300725504231,270825005743,170625504645,270825501518,170625504648,280825501550,270825004858,270825501519,270825005944,120825501012,260825024202,250924508862,280825501528,260825022621,120825500828,270825500983,300625006571,200825011910,220725025418,200825013889,090325003202,280825016381,290825018048,260825018645,030724501322,150524501216,150524501033,150524501163,150524501214,290825017353,280825020945,050925020789,200825036132,050925021066,120525007756,210825019715,250825017320,210825020063,010925010188,050925007495,250825005603,080925007023,260825008191,040925022363,050625024656,120825015534,110625030220,120224006274,120825010496,280725024014,250825025031,190724501605,250825024721,160822501861,160822501865,070825024378,250825024796,261018623106,250825024888,220824500191,160822501860,250825025085,250825025116,011024500486,031024502627,011024501936,080222500562,230125505331,230125505549,230125505280,240125500083,230125505335,230125505295,230125505284,230125505319,230125505282,230125505294,230125505330,230125505305,230125505318,230125505310,230125505325,230125505317,230125505296,230125505304,230125505309,230125505300,090925021491,210224501660,200524502575,210224500994,301224505947,210224501659,280825023651,290825012835,030925012014,160825003815,080925005733,180825011578,160825003760,290825018149,270825010770,090925019896,120825035118,120825034915,070611500056,030611500337,210325911159,190825021726,190625026193,130623003539,120625017403,270525022927,190825021601,150225008598,260320600236,260320600228,040725024940,250825002186,240625009274,070825501693,070825501694,070825501692,030925011400,230225002014,160725502444,180825504209,180825500455,200525501813,230725502094,010825501164,030925502281,010825501166,210725009734,280425002016,290525034366,240725019694,100925008903,110825918749,110825918766,110825918767,110825918751,110825918757,110825918779,110825918780,110825918782,110825914443,110825918777,110825915354,050124500526,110825914458,110825915355,110825910719,110825911703,110825918762,110825918778,110825911947,110825918774,280625502470,040925501336,030925013945,030925028920,180725501106,220521500270,060825501787,200521501587,060825501784,051223500920,060825501785,010824502519,070125502279,060825501788,060825501789,060825501786,250325505455,190325508736,270120600013,190325511473,100925044398,100925044051,200325509165,280725006702,280725022936,140825033399,130825010789,310725029585,050825031927,190825026664,130825027335,100225017235,030625000249,160825004553,210825022886,210825043547,210825044019,210825043582,210825043471,080925034645,280225018447,260825016598,300824500908,180924501027,090523502455,070824502238,120624502761,300823500445,161224500586,110924500770,110924500768,111023501160,290124502525,130623501230,190625504754,241224502488,210825501941,201023500334,110924500769,041224505540,190324500373,090224501200,010825505758,080825503524,100425501300,100425501145,200325505830,080825503345,100725504787,120825035120,180825005109,200825023605,090925012884,160825001552,160825004419,080925022266,090825008615,220825012729,140825013319,310725006063,010925006714,010925014841,140825032949,260825015186,100725019006,130825010142,010925010308,130825010307,280725021204,050925019733,210825023424,300825016200,170225504450,170225504451,180924502619,240625505826,120825014914,190725500385,040725500503,050725500815,180924502606,180924502618,190625025567,250924501539,240625501971,190625025321,210725012954,140825502050,050825500109,050825500116,050825500115,280723503651,280723503652,220725025485,190625025131,020925024094,220825028258,300725505808,280725504108,290825502062,040825504051,290725500247,280725503837,310725501637,310725501638,220525504732,040216502540,220715500840,240715500618,301018501720,150317500002,150317500227,150317500001,240715500617,260318502806,040216502385,220715500887,260318502807,240715500615,150317500003,310815505636,310815505625,250417507791,050216502115,220715500876,010925004547,180425015093,260523005099,210923009363,210122005779,041221003282,300823007832,191021002786,300825016530,020925027491,250325008487,030225004213,101124001269,060825013585,040622002618,250725025893,200122000566,210824005135,210825035553,200825036162,270825022227,200825036220,270825914232,130825014917,260825027648,090925021574,200825031052,160825001702,141124505236,190620501110,110724500745,261223500966,120221501186,221223501539,200325504653,010525501394,261223500961,121124504621,261223500960,261223500962,120221501187,261223500968,261223500964,261223500963,171024500849,210625500867,261223500965,261223500967,030724500474,270825918439,270825918430,270825918438,270825918434,270825918460,270825918458,140825033657,270825918468,300725016492,270825918448,270825918461,270825918447,270825918457,270825918466,270825918463,270825918437,270825918417,270825918456,270825918464,270825918415,140825025482,300825016906,190825025773,020925025529,011223500997,160323501389,210625501131,120924502732,210715500751,250223500217,160823500635,090925019219,110324501137,291024505300,140923500390,130225505013,040825500622,300625500158,300625500037,300625500038,110225506736,130225505265,040225504238,100725036013,110825004836,031023501443,240823502615,080925033876,240823502614,240823502613,240823502616,240823502620,240823502612,240823502619,240823502617,240823502618,240823502611,091224003667,110725014611,100925020706,120825017450,120825017100,280825007637,010825504050,210825043556,300725502119,210825503667,020925014301,231224004899,080825501788,040825505846,080825501787,010925021389,020925501802,090925030021,090925502883,260824006170,220725026649,110325924673,100925503373,100925500597,090925504432,110325915446,260625503740,290725011399,290224004206,110925011842,110925011669,090925502131,090925501347,290825010102,220725022540,030925500844,010925501781,130825019773,260825014863,130825017623,020925024208,110825014644,270825019679,020925017788,260825018288,180825011809,270825021386,230825013729,300525026296,310725020032,200825022530,080523501356,160523500087,200224501139,080523501501,230825012838,260825009103,050925007094,040925004678,290724911041,100925044294,210825021299,200825030439,301224503561,200825504113,140625500772,180425505252,150524501432,301224503387,150524501431,110925011548,010824500904,050925504163,240624501848,190924502611,270825005896,020925027710,250825003621,220825025503,310523004207,290425500378,290425500377,060925001287,290425500358,290425500376,290425500357,290425500375,290425500372,100925023792,280825009612,290825008846,290425500362,250825019928,220825007441,140825030178,140825029956,010925010129,270325024667,031024007277,100425008858,291118600528,020925018841,260825023092,080925021248,170625025308,300725026643,180825004016,220825021371,250724914736,260225014624,040925012498,040825005516,210825944826,200825917384,200825919922,210825936406,210825936404,050925920554,210825936409,270825913126,270825913127]

// Helper to chunk array
function chunkArray(arr, size) {
    const result = [];
    for (let i = 0; i < arr.length; i += size) {
        result.push(arr.slice(i, i + size));
    }
    return result;
}

async function getNaukriCookiesAndHeaders() {
    const browser = await puppeteer.launch({
        headless: true,
        args: ['--no-sandbox']
    });
    const page = await browser.newPage();
    await page.goto('https://www.naukri.com', { waitUntil: 'networkidle2' });
    const cookies = await page.browserContext().cookies();
    await browser.close();

    const cookieHeader = cookies.map(c => `${c.name}=${c.value}`).join('; ');
    return {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',
        'accept': 'application/json',
        'accept-language': 'en-US,en;q=0.9',
        'appid': 109,
        'content-type': 'application/json',
        'gid': 'LOCATION,INDUSTRY,EDUCATION,FAREA_ROLE',
        'priority': 'u=1, i',
        'systemid': 109,
        'Cookie': cookieHeader
    };
}

async function scrapeGroupId(groupId, headers) {
    try {
        const url = `https://www.naukri.com/jobapi/v4/job/${groupId}`;
        const response = await axios.get(url, { headers });
        // const response = { data: { groupId } }; // for mocking
        const filePath = path.join(scrapedDir, `${groupId}.json`);
        fs.writeFileSync(filePath, JSON.stringify(response.data, null, 2));
        console.log(`✅ Saved ${filePath}`);
        return { groupId, success: true };
    } catch (error) {
        console.error(`❌ Failed scraping ${groupId}:`, error.message);
        return { groupId, success: false, error: error.message };
    }
}

app.get('/scrape', async (req, res) => {
    // Get fresh headers/cookies for this major group
    const headers = await getNaukriCookiesAndHeaders();

    // Batch into 9 major groups (1000 groupIds each)
    const majorGroups = chunkArray(groupIds, 1000);

    const limit = pLimit(10); // limit concurrency of axios requests

    console.log(`🚀 Starting scraping for ${groupIds.length} groupIds in ${majorGroups.length} major groups`);

    for (let majorIndex = 0; majorIndex < majorGroups.length; majorIndex++) {
        const majorGroup = majorGroups[majorIndex];
        console.log(`\n➡️ Processing major group ${majorIndex + 1} / ${majorGroups.length}`);


        // Now chunk major group into subgroups of 100 groupIds each
        const subGroups = chunkArray(majorGroup, 100);

        for (let subIndex = 0; subIndex < subGroups.length; subIndex++) {
            const subGroup = subGroups[subIndex];
            console.log(`  🔹 Scraping subgroup ${subIndex + 1} / ${subGroups.length} (size: ${subGroup.length})`);

            // Run all requests in this subgroup in parallel but with concurrency limit
            const promises = subGroup.map(groupId =>
                limit(() => scrapeGroupId(groupId, headers))
            );

            const results = await Promise.all(promises);

            const successCount = results.filter(r => r.success).length;
            const failCount = results.length - successCount;

            console.log(`  ✅ Subgroup done. Success: ${successCount}, Fail: ${failCount}`);
        }
    }

    console.log(`\n🎉 All scraping done!`);

    res.send(`
    ✅ All scraping done!<br>
    <a href="/">⬅️ Go back</a><br>
    <a href="/download-all">📦 Download All JSON Files</a>
  `);
});

// Zip download endpoint (same as yours)
app.get('/download-all', (req, res) => {
    const archive = archiver('zip', { zlib: { level: 9 } });
    res.setHeader('Content-Disposition', 'attachment; filename="naukri-jsons.zip"');
    res.setHeader('Content-Type', 'application/zip');
    archive.pipe(res);
    archive.directory(scrapedDir, false);
    archive.finalize();
});

// Home page
app.get('/', (req, res) => {
    res.send(`
    <h2>🧠 Naukri Scraper</h2>
    <p><a href="/scrape">▶️ Run Scraper</a></p>
    <p><a href="/download-all">📥 Download All JSONs (ZIP)</a></p>
    <p>Once scraped, you can also access individual files like: <code>/4632583.json</code></p>
  `);
});

app.listen(PORT, () => {
    console.log(`🚀 Server running at http://localhost:${PORT}`);
});
